#!/bin/bash
set -e

# --- 1. å®šä¹‰ cfmonitor.sh çš„é…ç½®è·¯å¾„å’Œæ–‡ä»¶ ---
# æ³¨æ„ï¼šcfmonitor.sh é»˜è®¤è·¯å¾„æ˜¯ $HOME/.cf-vps-monitorï¼Œä½†åœ¨ Docker é‡Œæˆ‘ä»¬ä½¿ç”¨ /app/config
CF_DIR="/app/.cf-vps-monitor"
CF_CONFIG_FILE="$CF_DIR/config/config"
CF_SERVICE_FILE="$CF_DIR/bin/vps-monitor-service.sh"

# --- 2. æ£€æŸ¥å¹¶åˆ›å»º cfmonitor é…ç½® (é€šè¿‡çŽ¯å¢ƒå˜é‡) ---

if [[ -n "$CF_WORKER_URL" || -n "$CF_SERVER_ID" ]]; then
    echo "--- âš™ï¸ å‘çŽ°é…ç½®çŽ¯å¢ƒå˜é‡ï¼Œå¼€å§‹è‡ªåŠ¨ç”Ÿæˆ cfmonitor é…ç½® ---"
    
    # ç¡®ä¿é…ç½®ç›®å½•å­˜åœ¨
    mkdir -p "$CF_DIR/config" "$CF_DIR/logs" "$CF_DIR/run" "$CF_DIR/bin"
    
    # å°†çŽ¯å¢ƒå˜é‡å†™å…¥è„šæœ¬æœŸæœ›çš„é…ç½®æ–‡ä»¶æ ¼å¼
    # æ³¨æ„: cfmonitor.sh è„šæœ¬çš„é€»è¾‘éœ€è¦ä¿®æ”¹æˆ–ç»•è¿‡å…¶å†…éƒ¨çš„å®‰è£…é€»è¾‘
    # é‰´äºŽåŽŸå§‹è„šæœ¬ç»“æž„ï¼Œæœ€ç›´æŽ¥çš„æ–¹å¼æ˜¯ç”Ÿæˆä¸€ä¸ªé…ç½®æ–‡ä»¶æˆ–ç›´æŽ¥ä½¿ç”¨çŽ¯å¢ƒå˜é‡
    
    # å†™å…¥é…ç½®æ–‡ä»¶ (å‡è®¾ cfmonitor.sh ä¾èµ– ini æˆ–ç±»ä¼¼æ ¼å¼ï¼Œæˆ–æˆ‘ä»¬ç›´æŽ¥ç”¨å˜é‡)
    # cfmonitor.sh çš„é…ç½®é€»è¾‘åœ¨è„šæœ¬å†…éƒ¨ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆç”Ÿæˆä¸€ä¸ª shell é…ç½®æ–‡ä»¶ä¾›å…¶è°ƒç”¨
    
    echo "# Generated by Docker Entrypoint" > "$CF_CONFIG_FILE"
    echo "CF_WORKER_URL=\"$CF_WORKER_URL\"" >> "$CF_CONFIG_FILE"
    echo "CF_SERVER_ID=\"$CF_SERVER_ID\"" >> "$CF_CONFIG_FILE"
    
    if [ -n "$CF_INTERVAL" ]; then
        echo "CF_INTERVAL=$CF_INTERVAL" >> "$CF_CONFIG_FILE"
    fi
    if [ -n "$CF_API_KEY" ]; then
        echo "CF_API_KEY=\"$CF_API_KEY\"" >> "$CF_CONFIG_FILE"
    fi
    
    # æç¤ºç”¨æˆ·åœ¨è¿è¡Œ cfmonitor ä¹‹å‰ï¼Œå¯èƒ½ä»éœ€è¦ 'install' å‘½ä»¤æ¥è®¾ç½®æœåŠ¡æ–‡ä»¶
    echo "âœ… cfmonitor é…ç½®æ–‡ä»¶å·²å†™å…¥: $CF_CONFIG_FILE"
    
    # è­¦å‘Šï¼šcfmonitor.sh å†…éƒ¨æœ‰ç¡¬ç¼–ç è·¯å¾„ã€‚
    # ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥ä¿®æ”¹ cfmonitor.sh è„šæœ¬ï¼Œè®©å®ƒä½¿ç”¨çŽ¯å¢ƒå˜é‡æˆ–ç‰¹å®šçš„é…ç½®è·¯å¾„ã€‚
    # åœ¨è¿™ä¸ª Docker å®¹å™¨ä¸­ï¼Œæˆ‘ä»¬æš‚æ—¶å‡è®¾å®ƒèƒ½å¤Ÿè¯»å–æˆ–æˆ‘ä»¬å¼ºåˆ¶ä½¿ç”¨å®ƒã€‚
    
    # âš ï¸ å¯åŠ¨ cfmonitor æœåŠ¡ï¼šå¦‚æžœæä¾›äº† URLï¼Œå¹¶ä¸”ç”¨æˆ·æ²¡æœ‰æŒ‡å®šå…¶ä»–å‘½ä»¤ï¼Œåˆ™è¿è¡Œå®‰è£…å’Œå¯åŠ¨ã€‚
    if [ "$#" -eq 0 ] && [ -n "$CF_WORKER_URL" ]; then
        echo "--- ðŸš€ è‡ªåŠ¨æ‰§è¡Œ cfmonitor install å’Œ start ---"
        /usr/local/bin/cfmonitor.sh install
        exec /usr/local/bin/cfmonitor.sh start
    fi
fi

# --- 3. å‘½ä»¤è¡Œå‚æ•°å¤„ç† (æ ¸å¿ƒé€»è¾‘ä¸å˜) ---

# å¦‚æžœæ²¡æœ‰å‚æ•°ä¼ å…¥ï¼Œæ˜¾ç¤ºå¸®åŠ©/èœå•
if [ "$#" -eq 0 ]; then
    echo "--- ðŸ“¦ Dockerized Multi-Tool ---"
    echo "Usage: docker run [IMAGE] [COMMAND] [ARGS...]"
    echo ""
    echo "Configuration (via -e):"
    echo "  CF_WORKER_URL (Required for cfmonitor auto-start)"
    echo "  CF_SERVER_ID"
    echo "  CF_INTERVAL"
    echo "  CF_API_KEY"
    echo ""
    echo "Commands:"
    echo "  cfmonitor [install|start|status|...]"
    echo "  cloudsbx [rep|install|...]"
    echo ""
    exit 0
fi

# æ ¹æ®ç¬¬ä¸€ä¸ªå‚æ•°å†³å®šæ‰§è¡Œå“ªä¸ªè„šæœ¬
case "$1" in
    cfmonitor)
        shift
        # è¿è¡Œ cfmonitor è„šæœ¬
        exec /usr/local/bin/cfmonitor.sh "$@"
        ;;
    cloudsbx)
        shift
        # è¿è¡Œ cloudsbx è„šæœ¬
        exec /usr/local/bin/cloudsbx.sh "$@"
        ;;
    install|uninstall|start|stop|restart|status|logs|config|test|menu)
        # é»˜è®¤æ‰§è¡Œ cfmonitor.sh çš„æœåŠ¡ç®¡ç†å‘½ä»¤
        exec /usr/local/bin/cfmonitor.sh "$@"
        ;;
    *)
        echo "Unknown command or script: $1" >&2
        exit 1
        ;;
esac
